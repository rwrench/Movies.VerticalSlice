@page "/movies"
@using Telerik.Blazor
@using Telerik.Blazor.Components

@inject IHttpClientFactory HttpClientFactory
<PageTitle>Movies</PageTitle>

<h2>Movies</h2>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success")" role="alert">
        @statusMessage
    </div>
}

<TelerikGrid Data="@movies"
             Pageable="true"
             PageSize="20"
             Sortable="true"
             Height="80vh"
             FilterMode="Telerik.Blazor.GridFilterMode.FilterRow"
             EditMode="GridEditMode.Inline"
             Resizable="true"
             @ref="gridRef">
    <GridToolBarTemplate>
        <GridCommandButton Command="Add">Add Movie</GridCommandButton>
    </GridToolBarTemplate>
    <GridColumns>
        <GridColumn Field="Title" Title="Title" Editable="true" Width="400px" />
        <GridColumn Field="YearOfRelease" Title="Year" Editable="true" Width="100px" />
        <GridColumn Field="Genres" Title="Year" Editable="true" Width="100px" />
        <GridCommandColumn Width="280px">
            <GridCommandButton Command="Edit" ShowInEdit="false">Edit</GridCommandButton>
            <GridCommandButton Command="Delete" ShowInEdit="false">Delete</GridCommandButton>
            <GridCommandButton Command="Save" ShowInEdit="true">Save</GridCommandButton>
            <GridCommandButton Command="Cancel" ShowInEdit="true">Cancel</GridCommandButton>
        </GridCommandColumn>
    </GridColumns>
</TelerikGrid>
@code {
    private HttpClient Http => HttpClientFactory.CreateClient("AuthorizedClient");
    private List<MovieDto> movies = new();
    private TelerikGrid<MovieDto>? gridRef;
    private string statusMessage = "";
    private bool isError = false;

    public record MovieDto(
      Guid MovieId,
      string Title,
      string Slug,
      int YearOfRelease,
      string Genres
  );

    protected override async Task OnInitializedAsync()  
    {  
        try {  
        {
            var result = await Http.GetFromJsonAsync<List<MovieDto>>("api/movies");
            movies = result ?? new List<MovieDto>();
            SetStatusMessage($"Loaded {movies.Count} movies", false);
        }
        }  
        catch (Exception ex)  
        {  
            statusMessage = "Error loading movies: " + ex.Message;  
            isError = true;  
        }
      
    }  

    async Task LoadMoviesAsync()  
    {  
        try  
        {  
            var result = await Http.GetFromJsonAsync<List<MovieDto>>("api/movies");
            movies = result ?? new List<MovieDto>();
            SetStatusMessage($"Loaded {movies.Count} movies", false);  
        }  
        catch (Exception ex)  
        {  
            SetStatusMessage($"Error loading movies: {ex.Message}", true);  
        }  
    }

    private void SetStatusMessage(string message, bool error)
    {
        statusMessage = message;
        isError = error;
        StateHasChanged();

        Task.Delay(5000).ContinueWith(_ => ClearStatusMessage());
    }

    private void ClearStatusMessage()
    {
        statusMessage = "";
        StateHasChanged();
    }
}