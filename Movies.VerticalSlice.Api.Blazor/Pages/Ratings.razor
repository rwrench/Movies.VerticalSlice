@page "/ratings"  
@using Microsoft.AspNetCore.Authorization
@using Telerik.Blazor
@using Telerik.Blazor.Components  
@using Telerik.DataSource
@using global::Movies.VerticalSlice.Api.Services  
@using global::Movies.VerticalSlice.Api.Shared.Dtos  
@inject IHttpClientFactory HttpClientFactory  
@inject IRatingsService RatingsService 
@attribute [Authorize]
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<TelerikGrid Data="@ratings"
             Pageable="true"
             PageSize="20"
             Sortable="true"
             Height="80vh"
             FilterMode="Telerik.Blazor.GridFilterMode.FilterRow"
             EditMode="GridEditMode.Inline"
             Resizable="true"
             @ref="gridRef"
             OnUpdate="OnUpdateHandler"
             OnDelete="OnDeleteHandler"
             OnCreate="OnCreateHandler"
             OnEdit="OnEditHandler"
             OnCancel="OnCancelHandler">

    <GridToolBarTemplate>
        <GridCommandButton Command="Add">Add Rating</GridCommandButton>
    </GridToolBarTemplate>
    <GridColumns>  
        <GridColumn Field="MovieName" Title="MovieName" Width="400px">
            <EditorTemplate Context="context">
                @{
                    var rating = context as MovieRatingWithNameDto;
                    if (rating != null)
                    {
                        <TelerikComboBox Data="@movieNames"
                                             TextField="Name"
                                             ValueField="Id"
                                             @bind-Value="rating.MovieId"
                                             Filterable="true"
                                             ScrollMode="DropDownScrollMode.Virtual"
                                             ItemHeight="30"
                                             PageSize="20"
                                             OnRead="@OnMovieComboBoxRead"
                                             OnChange="OnMovieComboBoxChange"
                                             Placeholder="Select a movie" />
                    }
                }
            </EditorTemplate>
        </GridColumn>
        <GridColumn Field="Rating" Title="Rating" Width="100px" />  
        <GridColumn Field="DateUpdated" Title="DateUpdated" Width="300px" EditorType="@GridEditorType.DateTimePicker"/>
        <GridColumn Field="UserName" Title="UserName" Width="300px" Editable="false"/>
        <GridCommandColumn Width="280px">
            <GridCommandButton Command="Edit" ShowInEdit="false">Edit</GridCommandButton>
            <GridCommandButton Command="Delete" ShowInEdit="false">Delete</GridCommandButton>
            <GridCommandButton Command="Save" ShowInEdit="true">Save</GridCommandButton>
            <GridCommandButton Command="Cancel" ShowInEdit="true">Cancel</GridCommandButton>
        </GridCommandColumn>
    </GridColumns>  
     

</TelerikGrid>  
  
@code {
    private List<MovieRatingWithNameDto> ratings = new();  
    private HttpClient Http => HttpClientFactory.CreateClient("AuthorizedClient");  
    private TelerikGrid<MovieRatingWithNameDto>? gridRef;
    private string statusMessage = "";  
    private bool isError = false;  
    private MovieRatingWithNameDto? selectedMovie = null;

    private List<MovieNameDto> movieNames = new();

    async Task OnMovieComboBoxRead(ComboBoxReadEventArgs args)
    {
        string filter = args.Request.Filters
            .OfType<FilterDescriptor>()
            .FirstOrDefault()?.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(filter))
        {
            filter = selectedMovie?.MovieName ?? string.Empty;
        }
        movieNames = await RatingsService.GetAllMovieNamesAsync(filter) 
            ?? new List<MovieNameDto>();

        args.Data = movieNames;
    }

    void OnMovieComboBoxChange(object args)
    {
        Guid? selectedMovieId = null;

        if (args is Guid guid)
        {
            selectedMovieId = guid;
        }
        else if (args is string movieIdString && Guid.TryParse(movieIdString, out Guid movieId))
        {
            selectedMovieId = movieId;
        }

        if (selectedMovieId.HasValue)
        {
            var movie = movieNames.FirstOrDefault(m => m.MovieId == selectedMovieId.Value);
            if (selectedMovie != null)
            {
                selectedMovie.MovieId = selectedMovieId.Value;
                selectedMovie.MovieName = movie?.MovieName ?? string.Empty;
            }
        }
    }
    protected override async Task OnInitializedAsync()  
    {  
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity == null || !authState.User.Identity.IsAuthenticated)
        {
            Navigation.NavigateTo("/login", true);
        }
        await LoadRatingsAsync();  
    }  

    public async Task OnUpdateHandler(GridCommandEventArgs args)  
    {  
        if (args.Item is not MovieRatingWithNameDto rating) return;
        await RatingsService.UpdateAsync(rating);
        await LoadRatingsAsync();
    }  

   public async Task OnCreateHandler(GridCommandEventArgs args)
    {
        if (args.Item is not MovieRatingWithNameDto rating) return;
        await RatingsService.CreateAsync(rating);
        await LoadRatingsAsync();
    }

    public async Task OnDeleteHandler(GridCommandEventArgs args)  
    {  
        if (args.Item is not MovieRatingWithNameDto rating) return;  
        await RatingsService.DeleteAsync(rating.Id);  
        await LoadRatingsAsync();  
    }  

    Task OnEditHandler(GridCommandEventArgs e)  
    {  
        selectedMovie = e.Item as MovieRatingWithNameDto;
        return Task.CompletedTask;  
    }  

    Task OnCancelHandler(GridCommandEventArgs e)  
    {  
        ClearStatusMessage();  
        return Task.CompletedTask;  
    }  


    async Task LoadRatingsAsync()  
    {  
        try  
        {  
            ratings = await RatingsService.GetAllAsync() ?? new List<MovieRatingWithNameDto>();  
            SetStatusMessage($"Loaded {ratings.Count} ratings", false);  
        }  
        catch (Exception ex)  
        {  
            SetStatusMessage($"Error loading ratings: {ex.Message}", true);  
        }  
    }  

    async Task LoadMovieNamesAsync()
    {
        try
        {
            movieNames = await RatingsService.GetAllMovieNamesAsync("") ?? new List<MovieNameDto>();
            SetStatusMessage($"Loaded {movieNames.Count}", false);
        }
        catch (Exception ex)
        {
            SetStatusMessage($"Error loading ratings: {ex.Message}", true);
        }
    }

    void SetStatusMessage(string message, bool error)  
    {  
        statusMessage = message;  
        isError = error;  
        StateHasChanged();  

        Task.Delay(5000).ContinueWith(_ => ClearStatusMessage());  
    }  

    void ClearStatusMessage()  
    {  
        statusMessage = "";  
        StateHasChanged();  
    }  

 
}