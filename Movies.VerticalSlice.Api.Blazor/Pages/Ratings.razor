@page "/ratings"  
@using Telerik.Blazor
@using Telerik.Blazor.Components  
@using global::Movies.VerticalSlice.Api.Blazor.Services  
@using global::Movies.VerticalSlice.Api.Shared.Dtos  
@inject IHttpClientFactory HttpClientFactory  
@inject RatingsService RatingsService  

<TelerikGrid Data="@ratings"
             Pageable="true"
             PageSize="20"
             Sortable="true"
             Height="80vh"
             FilterMode="Telerik.Blazor.GridFilterMode.FilterRow"
             EditMode="GridEditMode.Inline"
             Resizable="true"
             @ref="gridRef"
             OnUpdate="OnUpdateHandler"
             OnDelete="OnDeleteHandler"
             OnCreate="@OnCreateHandler"
             OnEdit="@OnEditHandler"
             OnCancel="@OnCancelHandler">

    <GridToolBarTemplate>
        <GridCommandButton Command="Add">Add Rating</GridCommandButton>
    </GridToolBarTemplate>
    <GridColumns>  
        <GridColumn Field="Id" Title="Id" Width="300px" />
        <GridColumn Field="MovieName" Title="MovieName" Width="400px"/>  
        <GridColumn Field="Rating" Title="Rating" Width="100px"/>  
        <GridColumn Field="DateUpdated" Title="DateUpdated" Width="300px" />
        <GridCommandColumn Width="280px">
            <GridCommandButton Command="Edit" ShowInEdit="false">Edit</GridCommandButton>
            <GridCommandButton Command="Delete" ShowInEdit="false">Delete</GridCommandButton>
            <GridCommandButton Command="Save" ShowInEdit="true">Save</GridCommandButton>
            <GridCommandButton Command="Cancel" ShowInEdit="true">Cancel</GridCommandButton>
        </GridCommandColumn>
    </GridColumns>  
     

</TelerikGrid>  
  
@code {  
    private List<MovieRatingWithNameDto> ratings = new();  
    private HttpClient Http => HttpClientFactory.CreateClient("AuthorizedClient");  
    private TelerikGrid<MovieRatingWithNameDto>? gridRef;
    private string statusMessage = "";  
    private bool isError = false;  
  
    protected override async Task OnInitializedAsync()  
    {  
        await LoadRatingsAsync();  
    }  
  
    async Task OnUpdateHandler(GridCommandEventArgs args)  
    {  
        if (args.Item is not MovieRatingWithNameDto updatedRating) return;  
        await RatingsService.CreateAsync(updatedRating);  
        await LoadRatingsAsync();  
    }  
  
    async Task OnDeleteHandler(GridCommandEventArgs args)  
    {  
        if (args.Item is not MovieRatingWithNameDto rating) return;  
        await RatingsService.DeleteAsync(rating.Id);  
        await LoadRatingsAsync();  
    }  
  
    async Task OnCreateHandler(GridCommandEventArgs args)  
    {  
        if (args.Item is not MovieRatingWithNameDto rating) return;
        await RatingsService.CreateAsync(rating);  
        await LoadRatingsAsync();  
    }  
    Task OnEditHandler(GridCommandEventArgs e)  
    {  
        return Task.CompletedTask;  
    }  
  
    Task OnCancelHandler(GridCommandEventArgs e)  
    {  
        ClearStatusMessage();  
        return Task.CompletedTask;  
    }  
    async Task LoadRatingsAsync()  
    {  
        try  
        {  
            ratings = await RatingsService.GetAllAsync() ?? new List<MovieRatingWithNameDto>();  
            SetStatusMessage($"Loaded {ratings.Count} ratings", false);  
        }  
        catch (Exception ex)  
        {  
            SetStatusMessage($"Error loading ratings: {ex.Message}", true);  
        }  
    }  
  
    void SetStatusMessage(string message, bool error)  
    {  
        statusMessage = message;  
        isError = error;  
        StateHasChanged();  
  
        Task.Delay(5000).ContinueWith(_ => ClearStatusMessage());  
    }  
  
    void ClearStatusMessage()  
    {  
        statusMessage = "";  
        StateHasChanged();  
    }  
}