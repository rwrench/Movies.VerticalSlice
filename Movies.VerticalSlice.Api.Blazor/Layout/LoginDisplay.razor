@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Movies.VerticalSlice.Api.Blazor.Authentication
@inject JwtAuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation
@inject ILogger<LoginDisplay> Logger

@code {
    private bool isAuthenticated;
    private string? userName;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name;
        AuthProvider.AuthenticationStateChanged += OnAuthStateChanged;
    }

    private async void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        var authState = await task;
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name;
        StateHasChanged();
    }

    private async Task Logout()
    {
        try
        {
            await AuthProvider.SetTokenAsync("");
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            // Silent fail on logout
        }
    }

    public void Dispose()
    {
        AuthProvider.AuthenticationStateChanged -= OnAuthStateChanged;
    }
}

@if (isAuthenticated)
{
    <span>@userName</span>
    <button class="nav-link btn btn-link" @onclick="Logout">Log out</button>
}
else
{
    <a href="/login">Log in</a>
}
